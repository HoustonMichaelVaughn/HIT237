{% extends "mango_pests/base.html" %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-4">Welcome, {{ user.username }}!</h2>

  <!-- Grower Stats Overview -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5 class="card-title">Farm Blocks</h5>
          <p class="card-text">{{ total_blocks }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5 class="card-title">Pest Checks</h5>
          <p class="card-text">{{ total_checks }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Farm Blocks Table -->
  <h3>Your Farm Blocks</h3>
  <form method="get" class="mb-2">
    <div class="input-group w-50 mb-2">
      <input type="text" name="fb_search" class="form-control" placeholder="Search farm blocks..." value="{{ fb_search }}">
      <button type="submit" class="btn btn-primary">Search</button>
      {% if fb_search %}
      <a href="?" class="btn btn-outline-secondary">Clear</a>
      {% endif %}
    </div>
  </form>
  <table class="table table-bordered table-hover">
    <thead>
      <tr><th>Name</th><th>Location</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for block in farm_blocks %}
      <tr>
        <td>{{ block.name }}</td>
        <td>{{ block.location_description }}</td>
        <td>
          <a href="{% url 'edit_farm_block' block.pk %}" class="btn btn-sm btn-warning">Edit</a>
          <a href="{% url 'delete_farm_block' block.pk %}" class="btn btn-sm btn-danger">Delete</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="3">You haven't added any farm blocks yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if farm_blocks.paginator.num_pages > 1 %}
  <nav>
    <ul class="pagination">
      {% if farm_blocks.has_previous %}
        <li class="page-item"><a class="page-link" href="?fb_search={{ fb_search }}&fb_page={{ farm_blocks.previous_page_number }}">Previous</a></li>
      {% endif %}
      {% for num in farm_blocks.paginator.page_range %}
        <li class="page-item {% if farm_blocks.number == num %}active{% endif %}"><a class="page-link" href="?fb_search={{ fb_search }}&fb_page={{ num }}">{{ num }}</a></li>
      {% endfor %}
      {% if farm_blocks.has_next %}
        <li class="page-item"><a class="page-link" href="?fb_search={{ fb_search }}&fb_page={{ farm_blocks.next_page_number }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  <a href="{% url 'add_farm_block' %}" class="btn btn-primary mb-4 me-2">+ Add Farm Block</a>
  <a href="{% url 'create_pest_check' %}" class="btn btn-secondary mb-4">+ Add Pest Check</a>

  <!-- Recent Pest Checks -->
  <h3>Recent Pest Checks</h3>
  <form method="get" class="mb-2">
    <div class="input-group w-50 mb-2">
      <input type="text" name="pc_search" class="form-control" placeholder="Search pest checks..." value="{{ pc_search }}">
      <button type="submit" class="btn btn-primary">Search</button>
      {% if pc_search %}
      <a href="?" class="btn btn-outline-secondary">Clear</a>
      {% endif %}
    </div>
  </form>
  <form method="get" class="mb-3">
    <label for="status">Show checks with confidence:</label>
    <select name="status" id="status"
            onchange="this.form.submit()"
            class="form-control w-auto d-inline-block">
      <option value="all"    {% if status_filter == "all"    %}selected{% endif %}>All</option>
      <option value="high"   {% if status_filter == "high"   %}selected{% endif %}>High (≥ 90%)</option>
      <option value="medium" {% if status_filter == "medium" %}selected{% endif %}>Medium (50–89%)</option>
      <option value="low"    {% if status_filter == "low"    %}selected{% endif %}>Low (< 50%)</option>
    </select>
  </form>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Pest</th>
        <th>Date</th>
        <th>Block</th>
        <th>Trees</th>
        <th>Positives</th>
        <th>Confidence</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for check in recent_pest_checks %}
      <tr>
        <td>{{ check.pest.name }}</td>
        <td>{{ check.date_checked }}</td>
        <td>{{ check.farm_block.name }}</td>
        <td>{{ check.num_trees }}</td>
        <td>{{ check.positives }}</td>
        <td>
          {% if check.positives > 0 %}
            <span class="badge bg-danger">0%</span>
          {% else %}
            {% with pct=check.confidence|floatformat:0 %}
              {% if pct|floatformat:0 >= 90 %}
                <span class="badge bg-success">{{ pct }}&#37;</span>
              {% else %}
                <span class="badge bg-warning text-dark">{{ pct }}&#37;</span>
              {% endif %}
            {% endwith %}
          {% endif %}
        </td>
        <td>
          <a href="{% url 'edit_pest_check' check.id %}" class="btn btn-sm btn-warning">Edit</a>
          <a href="{% url 'delete_pest_check' check.id %}" class="btn btn-sm btn-danger">Delete</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="text-center">No pest checks found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if recent_pest_checks.paginator.num_pages > 1 %}
  <nav>
    <ul class="pagination">
      {% if recent_pest_checks.has_previous %}
        <li class="page-item"><a class="page-link" href="?pc_search={{ pc_search }}&pc_page={{ recent_pest_checks.previous_page_number }}">Previous</a></li>
      {% endif %}
      {% for num in recent_pest_checks.paginator.page_range %}
        <li class="page-item {% if recent_pest_checks.number == num %}active{% endif %}"><a class="page-link" href="?pc_search={{ pc_search }}&pc_page={{ num }}">{{ num }}</a></li>
      {% endfor %}
      {% if recent_pest_checks.has_next %}
        <li class="page-item"><a class="page-link" href="?pc_search={{ pc_search }}&pc_page={{ recent_pest_checks.next_page_number }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  <!-- Sampling Badge Legend -->
  <div class="mt-5 mb-4 p-3 border rounded bg-light">
    <h5>Sampling Status Badges</h5>
    <div>
      <span class="badge bg-success me-2">Green Badge (conf ≥ 90%)</span>
      <span class="badge bg-warning text-dark me-2">Yellow Badge (low sample)</span>
      <span class="badge bg-danger">Red Badge (pest found)</span>
    </div>
  </div>

  <!-- Accordion -->
  <div class="accordion mb-3" id="dashboardAccordion">
    <!-- Surveillance Confidence -->
    <div class="accordion-item">
      <h3 class="accordion-header" id="headingConfidence">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapseConfidence"
                aria-expanded="false" aria-controls="collapseConfidence">
          Check My Surveillance Confidence
        </button>
      </h3>
      <div id="collapseConfidence"
           class="accordion-collapse collapse"
           aria-labelledby="headingConfidence"
           data-bs-parent="#dashboardAccordion">
        <div class="accordion-body">
          <form method="post"
                id="confidence-form"
                hx-post="{% url 'confidence_check' %}"
                hx-target="#confidence-result"
                hx-swap="innerHTML"
                hx-on="htmx:afterSwap: document.getElementById('confidence-result-anchor').scrollIntoView({ behavior: 'smooth', block: 'start' })">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-secondary">Evaluate Surveillance Effort</button>
          </form>
          <div id="confidence-result-anchor">
            <div id="confidence-result"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sample Size Calculator -->
    <div class="accordion-item">
      <h3 class="accordion-header" id="headingSampleSize">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapseSampleSize"
                aria-expanded="false" aria-controls="collapseSampleSize">
          How Many Trees Should I Check?
        </button>
      </h3>
      <div id="collapseSampleSize"
           class="accordion-collapse collapse"
           aria-labelledby="headingSampleSize"
           data-bs-parent="#dashboardAccordion">
        <div class="accordion-body">
          <form method="post"
                id="sample-form"
                hx-post="{% url 'sample_check' %}"
                hx-target="#sample-result"
                hx-swap="innerHTML"
                hx-on="htmx:afterSwap: document.getElementById('sample-result-anchor').scrollIntoView({ behavior: 'smooth', block: 'start' })">
            {% csrf_token %}
            {{ sample_form.as_p }}
            <button type="submit" class="btn btn-secondary">
              Calculate Required Sample Size
            </button>
          </form>
          <div id="sample-result-anchor">
            <div id="sample-result"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pests Table -->
  <h3>Your Pests</h3>
  <form method="get" class="mb-2">
    <div class="input-group w-50 mb-2">
      <input type="text" name="pest_search" class="form-control" placeholder="Search pests..." value="{{ pest_search }}">
      <button type="submit" class="btn btn-primary">Search</button>
      {% if pest_search %}
      <a href="?" class="btn btn-outline-secondary">Clear</a>
      {% endif %}
    </div>
  </form>
  <table class="table table-bordered table-hover">
    <thead>
      <tr><th>Name</th><th>Scientific Name</th><th>Plant Type</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for pest in pests %}
      <tr>
        <td>{{ pest.name }}</td>
        <td>{% if pest.scientific_name %}{{ pest.scientific_name }}{% else %}-{% endif %}</td>
        <td>{{ pest.plant_type.name }}</td>
        <td>
          {% if not pest.is_static %}
            <a href="{% url 'edit_pest' pest.pk %}" class="btn btn-sm btn-warning">Edit</a>
            <a href="{% url 'delete_pest' pest.pk %}" class="btn btn-sm btn-danger">Delete</a>
          {% else %}
            <span class="badge bg-info">Base Pest</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="4">No pests added yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if pests.paginator.num_pages > 1 %}
  <nav>
    <ul class="pagination">
      {% if pests.has_previous %}
        <li class="page-item"><a class="page-link" href="?pest_search={{ pest_search }}&pest_page={{ pests.previous_page_number }}">Previous</a></li>
      {% endif %}
      {% for num in pests.paginator.page_range %}
        <li class="page-item {% if pests.number == num %}active{% endif %}"><a class="page-link" href="?pest_search={{ pest_search }}&pest_page={{ num }}">{{ num }}</a></li>
      {% endfor %}
      {% if pests.has_next %}
        <li class="page-item"><a class="page-link" href="?pest_search={{ pest_search }}&pest_page={{ pests.next_page_number }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  <a href="{% url 'create_pest' %}" class="btn btn-primary mb-4 me-2">+ Add Pest</a>
</div>

<!-- HTMX for AJAX -->
<script src="https://unpkg.com/htmx.org@1.9.5"></script>

<!-- Bootstrap Tooltip Init -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
{% endblock %}
